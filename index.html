<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Viabilidade Financeira - Integrado (Final v15)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://unpkg.com/html-docx-js/dist/html-docx.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- ESTILOS VISUAIS --- */
        :root { --primary: #333; --accent: #2c3e50; --bg: #f4f6f8; --success: #28a745; --danger: #dc3545; --warning: #ffc107; --info: #17a2b8; --preview-bg: #525659; }
        
        body { font-family: 'Segoe UI', 'Roboto', Arial, sans-serif; background: var(--bg); margin: 0; padding: 0; display: flex; justify-content: center; min-height: 100vh; }
        .container { display: flex; gap: 25px; width: 100%; max-width: 1200px; padding: 40px 20px; align-items: flex-start; justify-content: center; }
        
        /* CARDS */
        .card { background: white; padding: 35px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 100%; animation: fadeIn 0.3s ease; }
        .resumo-card { background: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); width: 350px; position: sticky; top: 20px; min-height: 200px; display: none; }

        /* DASHBOARD */
        .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-top: 50px; }
        .menu-btn {
            background: white; border: 1px solid #e0e0e0; border-radius: 12px; padding: 50px 30px;
            text-align: center; cursor: pointer; transition: 0.3s; display: flex; flex-direction: column; align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
        }
        .menu-btn:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); border-color: var(--accent); }
        .menu-btn i { font-size: 50px; color: var(--accent); margin-bottom: 20px; }
        .menu-btn h3 { margin: 0; color: #333; font-size: 1.5rem; }
        .menu-btn p { color: #777; margin-top: 10px; }

        /* FORMULÁRIOS */
        h1.app-title { text-align: center; color: var(--accent); margin-bottom: 10px; }
        h2 { border-bottom: 1px solid #eee; padding-bottom: 15px; color: #333; margin-top: 0; font-size: 1.5rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .section-title { font-size: 14px; color: #666; text-transform: uppercase; border-left: 4px solid #333; padding-left: 10px; margin: 0; font-weight: bold; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: 600; margin-bottom: 6px; font-size: 12px; color: #555; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-size: 14px; background: #fff; }
        input[readonly] { background-color: #f0f0f0; color: #555; font-weight: bold; border-color: #ccc; cursor: not-allowed; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; }

        /* BOTÕES */
        .btn { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.2s; width: 100%; font-size: 13px; text-transform: uppercase; }
        
        button:disabled { background-color: #cccccc !important; color: #666 !important; cursor: not-allowed !important; box-shadow: none !important; }

        .btn-add-compact { 
            background-color: var(--success); color: white; border: none; 
            padding: 10px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 13px; 
            display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; width: auto; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn-add-compact:hover { background-color: #218838; transform: translateY(-2px); }
        .btn-add-compact.editing { background-color: var(--warning); color: #333; }

        .btn-add-inline { background-color: var(--success); color: white; border: none; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        
        .btn-preview { background: #6f42c1; color: white; margin-top: 10px; padding: 15px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-preview:hover { background: #5a32a3; }
        
        .btn-save-tec { background: var(--warning); color: #333; margin-top: 20px; padding: 15px; font-size: 14px; }
        .btn-save-tec:hover { background: #ffca2c; }

        .btn-back { background: #6c757d; color: white; margin-top: 10px; }
        .btn-back:hover { background: #5a6268; }

        .btn-upload { background: var(--info); color: white; margin-top: 20px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 14px; }
        .btn-upload:hover { background: #138496; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: flex-start; z-index: 1000; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .modal-content { background: var(--preview-bg); width: 100%; max-width: 900px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); display: flex; flex-direction: column; overflow: hidden; margin-top: 20px; margin-bottom: 20px; }
        .modal-header { background: #333; color: white; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { padding: 30px; background: #525659; display: flex; justify-content: center; overflow-y: auto; max-height: 70vh; }
        .paper-a4 { background: white; width: 210mm; min-height: 297mm; padding: 20mm; box-shadow: 0 0 10px rgba(0,0,0,0.5); font-family: Arial, sans-serif; font-size: 11pt; color: #000; box-sizing: border-box; }
        .modal-footer { background: #fff; padding: 15px; display: flex; justify-content: flex-end; gap: 10px; border-top: 1px solid #ddd; }

        /* RESUMO */
        #lista-resumo { list-style: none; padding: 0; margin-top: 20px; border-top: 1px solid #eee; }
        .item-resumo { padding: 15px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .item-info b { color: #333; font-size: 14px; display: block; }
        .item-info span { color: #777; font-size: 11px; }
        .valor-total-container { margin-top: 20px; }
        .lbl-total { font-size: 11px; font-weight: bold; color: #777; text-transform: uppercase; display: block; }
        .val-total-com { font-size: 22px; font-weight: bold; color: var(--success); }
        .val-total-tec { font-size: 22px; font-weight: bold; color: var(--accent); }
        .acoes-item { display: flex; gap: 5px; align-items: center; }
        .btn-icon { background: none; border: none; cursor: pointer; color: #999; font-size: 14px; padding: 5px; transition: 0.2s; }
        .btn-icon:hover { color: var(--primary); transform: scale(1.1); }
        .btn-icon.edit:hover { color: var(--warning); }
        .btn-icon.del:hover { color: var(--danger); }
        #secao-parceira { background: #f9f9f9; border: 1px dashed #ccc; padding: 15px; border-radius: 5px; margin-top: 10px; display: none; }
        .screen { display: none; }
        .screen.active { display: block; }
    </style>
</head>
<body>

<div class="container" id="main-container">
    
    <div id="tela-inicial" class="screen active" style="width: 100%; max-width: 800px;">
        <h1 class="app-title">Viabilidade Financeira</h1>
        <p style="text-align: center; color: #777;">Selecione o setor para iniciar</p>
        
        <div class="dashboard-grid">
            <div class="menu-btn" onclick="irPara('tela-comercial')">
                <i class="fa-solid fa-briefcase"></i>
                <h3>Comercial</h3>
                <p>Criar orçamentos e exportar arquivo.</p>
            </div>
            <div class="menu-btn" onclick="irPara('tela-tecnica')">
                <i class="fa-solid fa-screwdriver-wrench"></i>
                <h3>Equipe Técnica</h3>
                <p>Carregar arquivo e complementar.</p>
            </div>
        </div>
    </div>

    <div id="tela-comercial" class="card screen">
        <h2>Dados Comercial</h2>

        <div class="form-group">
            <label>Cliente/Projeto</label>
            <input type="text" id="projeto" oninput="validarComercial()">
        </div>
        <div class="row">
            <div class="form-group">
                <label>CNPJ</label>
                <input type="text" id="cnpj" placeholder="00.000.000/0000-00" maxlength="18" oninput="mascaraCNPJ(this); validarComercial()">
            </div>
            <div class="form-group"><label>Consultor</label><input type="text" id="consultor" oninput="validarComercial()"></div>
        </div>

        <div class="section-header">
            <h3 class="section-title">| CONFIGURAÇÃO DE PLANOS</h3>
        </div>
        
        <div class="form-group">
            <label>Plano</label>
            <select id="plano" onchange="atualizarValoresComercial()">
                <option value="0">Selecione...</option>
                <option value="150">Plano Smart - R$ 150,00</option>
                <option value="300">Plano Business - R$ 300,00</option>
                <option value="500">Plano Enterprise - R$ 500,00</option>
            </select>
        </div>
        
        <div class="row-3">
            <div class="form-group">
                <label>Quantidade</label>
                <input type="number" id="qtdPlano" value="1" min="1" oninput="atualizarValoresComercial()">
            </div>
            <div class="form-group">
                <label>Valor Unit. (R$)</label>
                <input type="text" id="valorUnitPlano" value="0,00" readonly>
            </div>
            <div class="form-group">
                <label>Total Item (R$)</label>
                <input type="text" id="totalItemPlano" value="0,00" readonly style="color: var(--success);">
            </div>
        </div>
        
        <div class="row">
            <div class="form-group">
                <label>Tipo de Serviço</label>
                <select id="servico">
                    <option value="Internet">Internet</option>
                    <option value="Voz">Voz</option>
                    <option value="Dados">Dados</option>
                </select>
            </div>
            <div class="form-group">
                <label>Data da Entrega</label>
                <input type="date" id="dataEntrega">
            </div>
        </div>

        <div class="form-group">
            <label>Parceira?</label>
            <select id="parceiraCheck" onchange="toggleParceira()">
                <option value="nao">Não</option>
                <option value="sim">Sim</option>
            </select>
        </div>

        <div id="secao-parceira">
            <div class="row">
                <div class="form-group"><label>Qtd. Pontos Parceira</label><input type="number" id="qtdParceira" value="0" oninput="atualizarValoresComercial()"></div>
                <div class="form-group"><label>Valor por Ponto (R$)</label><input type="number" id="valorParceira" value="0" oninput="atualizarValoresComercial()"></div>
            </div>
        </div>

        <div style="text-align: right;">
            <button id="btn-add-comercial" class="btn-add-compact" onclick="adicionarPlanoComercial()">
                <i class="fa-solid fa-plus"></i> Adicionar Plano
            </button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <button id="btn-export-comercial" class="btn btn-upload" onclick="exportarArquivoProjeto()" disabled>
            <i class="fa-solid fa-download"></i> SALVAR ARQUIVO PARA EQUIPE TÉCNICA
        </button>
        
        <button class="btn btn-preview" onclick="abrirPreview(false)">
            <i class="fa-solid fa-eye"></i> PRÉ-VISUALIZAR DOCUMENTO
        </button>
        
        <button class="btn btn-back" onclick="irPara('tela-inicial')">VOLTAR AO MENU</button>
    </div>

    <div id="tela-tecnica" class="card screen">
        <h2><i class="fa-solid fa-screwdriver-wrench"></i> Escopo Técnico</h2>
        
        <div id="area-upload" style="border: 2px dashed #ccc; padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; background: #f9f9f9;">
            <i class="fa-solid fa-file-import" style="font-size: 30px; color: #999; margin-bottom: 10px;"></i>
            <p style="margin: 0; color: #555; font-size: 14px;">Carregue o arquivo gerado pelo Comercial</p>
            <input type="file" id="arquivoInput" accept=".json" style="display: none;" onchange="carregarArquivo(this)">
            <button class="btn btn-add-inline" style="margin: 10px auto; width: auto;" onclick="document.getElementById('arquivoInput').click()">
                Selecionar Arquivo
            </button>
        </div>

        <div id="info-projeto-carregado" style="display: none; background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #2196f3;">
            <div style="font-size: 13px; color: #555; line-height: 1.6;">
                <div style="margin-bottom: 5px;">
                    <i class="fa-solid fa-check-circle" style="color: #2196f3;"></i> <b>Projeto Carregado</b>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <span><b>Cliente:</b> <span id="tec_display_cliente">---</span></span>
                    <span><b>Consultor:</b> <span id="tec_display_consultor">---</span></span>
                    <span><b>Data do Arquivo:</b> <span id="tec_display_data">---</span></span>
                    <span><b>Itens Comercial:</b> <span id="tec_display_itens_qtd">0</span></span>
                </div>
            </div>
        </div>

        <div id="area-tecnica-form" style="display: none;">
            <div class="section-header">
                <h3 class="section-title">| EQUIPAMENTOS E MÃO DE OBRA</h3>
            </div>

            <div class="form-group">
                <label>Equipamento / Descrição</label>
                <input type="text" id="tec_equipamento" placeholder="Ex: Roteador, Cabo, Instalação...">
            </div>

            <div class="row-3">
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="tec_qtd" value="1" min="1" oninput="calcTotalItemTec()">
                </div>
                <div class="form-group">
                    <label>Valor Unit. (R$)</label>
                    <input type="number" id="tec_valor" value="0" oninput="calcTotalItemTec()">
                </div>
                <div class="form-group">
                    <label>Total Item (R$)</label>
                    <input type="text" id="tec_total_preview" value="R$ 0,00" readonly style="color: var(--success);">
                </div>
            </div>

            <div class="form-group">
                <label>Tipo de Equipe</label>
                <select id="tec_tipo">
                    <option value="CLT">CLT (Própria)</option>
                    <option value="Terceira">Terceira</option>
                    <option value="Parceira">Parceira</option>
                    <option value="Duas Etapas">Duas Etapas</option>
                </select>
            </div>

            <div style="text-align: right;">
                <button id="btn-add-tecnico" class="btn-add-compact" onclick="adicionarItemTecnico()">
                    <i class="fa-solid fa-plus"></i> Adicionar Item
                </button>
            </div>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <button id="btn-preview-tec" class="btn btn-preview" onclick="abrirPreview(true)" disabled>
                <i class="fa-solid fa-eye"></i> PRÉ-VISUALIZAR DOCUMENTO
            </button>

        </div>

        <button class="btn btn-back" onclick="irPara('tela-inicial')">VOLTAR AO MENU</button>
    </div>

    <div id="resumo-container" class="resumo-card">
        <h2 style="font-size: 16px; border: none; margin-bottom: 0;">Resumo do Orçamento</h2>
        <div style="border-bottom: 1px solid #eee; margin-bottom: 10px;"></div>
        
        <div style="max-height: 400px; overflow-y: auto;">
            <h4 style="font-size: 11px; color: #999; margin: 10px 0 5px 0;">COMERCIAL</h4>
            <ul id="lista-resumo-com" style="list-style: none; padding: 0;">
                <li style="color: #999; font-size: 12px; text-align: center;">Nenhum plano.</li>
            </ul>

            <div id="bloco-resumo-tec" style="display: none;">
                <h4 style="font-size: 11px; color: #999; margin: 15px 0 5px 0; border-top: 1px dashed #eee; padding-top: 10px;">TÉCNICO</h4>
                <ul id="lista-resumo-tec" style="list-style: none; padding: 0;">
                    <li style="color: #999; font-size: 12px; text-align: center;">Nenhum equipamento.</li>
                </ul>
            </div>
        </div>
        
        <div class="valor-total-container">
            <div style="margin-bottom: 15px;">
                <span class="lbl-total">TOTAL PLANOS (COMERCIAL)</span>
                <div id="valTotalComercial" class="val-total-com">R$ 0,00</div>
            </div>
            
            <div id="box-total-tecnico" style="border-top: 1px dashed #ccc; padding-top: 10px; display: none;">
                <span class="lbl-total">TOTAL EQUIPAMENTOS (TÉCNICO)</span>
                <div id="valTotalTecnico" class="val-total-tec">R$ 0,00</div>
            </div>
        </div>
    </div>
</div>

<div id="modalPreview" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 style="margin:0;">Simulação do Documento (Visualização)</h3>
            <span style="cursor:pointer; font-size:24px;" onclick="fecharPreview()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="papelSimulacao" class="paper-a4"></div>
        </div>
        <div class="modal-footer">
            <button class="btn" style="background:#6c757d; color:white; width:auto;" onclick="fecharPreview()">Fechar</button>
            <button class="btn" style="background:var(--success); color:white; width:auto;" onclick="baixarDoModal()">
                <i class="fa-solid fa-download"></i> Baixar Word (.docX)
            </button>
        </div>
    </div>
</div>

<script>
    let dadosProjeto = {
        id: null,
        dataCriacao: null,
        comercial: { cliente: '', cnpj: '', consultor: '', itens: [] },
        tecnico: { itens: [] }
    };

    let editIndexCom = null;
    let editIndexTec = null;
    let modoCompletoGlobal = false;

    function resetarSistema() {
        // 1. Zera o objeto de dados
        dadosProjeto = {
            id: null,
            dataCriacao: null,
            comercial: { cliente: '', cnpj: '', consultor: '', itens: [] },
            tecnico: { itens: [] }
        };

        // 2. Limpa Inputs do Comercial
        document.getElementById('projeto').value = '';
        document.getElementById('cnpj').value = '';
        document.getElementById('consultor').value = '';
        document.getElementById('plano').value = '0';
        document.getElementById('qtdPlano').value = '1';
        document.getElementById('valorUnitPlano').value = '0,00';
        document.getElementById('totalItemPlano').value = '0,00';
        document.getElementById('servico').selectedIndex = 0;
        document.getElementById('dataEntrega').value = '';
        document.getElementById('parceiraCheck').value = 'nao';
        document.getElementById('qtdParceira').value = '0';
        document.getElementById('valorParceira').value = '0';
        toggleParceira();

        // 3. Limpa Inputs do Técnico
        document.getElementById('tec_equipamento').value = '';
        document.getElementById('tec_qtd').value = '1';
        document.getElementById('tec_valor').value = '0';
        document.getElementById('tec_total_preview').value = 'R$ 0,00';
        document.getElementById('tec_tipo').selectedIndex = 0;
        document.getElementById('arquivoInput').value = '';

        // 4. Reset das telas de info do técnico
        document.getElementById('area-upload').style.display = 'block';
        document.getElementById('info-projeto-carregado').style.display = 'none';
        document.getElementById('area-tecnica-form').style.display = 'none';

        // 5. Atualiza o resumo visual para ficar zerado
        renderizarResumo();
        validarComercial();
        validarTecnico();
    }

    function irPara(telaId) {
        document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
        document.getElementById(telaId).classList.add('active');

        const resumo = document.getElementById('resumo-container');
        const container = document.getElementById('main-container');
        const blocoTec = document.getElementById('bloco-resumo-tec');
        const boxTotalTec = document.getElementById('box-total-tecnico');

        if (telaId === 'tela-inicial') {
            resumo.style.display = 'none';
            container.style.maxWidth = '800px';
            boxTotalTec.style.display = 'none';
            resetarSistema(); // Zera tudo ao voltar para o menu
        } else {
            resumo.style.display = 'block';
            container.style.maxWidth = '1200px';
            renderizarResumo();
        }

        if (telaId === 'tela-tecnica') {
            blocoTec.style.display = 'block';
            boxTotalTec.style.display = 'block';
            resetarSistema(); // Zera ao entrar na técnica para forçar novo upload
        } 
        else if (telaId === 'tela-comercial') {
            blocoTec.style.display = 'none';
            boxTotalTec.style.display = 'none';
            resetarSistema(); // Zera ao iniciar novo comercial
        }
        
        validarComercial();
        validarTecnico();
    }

    // --- VALIDAÇÃO ---
    function validarComercial() {
        const p = document.getElementById('projeto').value.trim();
        const c = document.getElementById('cnpj').value.trim();
        const cons = document.getElementById('consultor').value.trim();
        const temItens = dadosProjeto.comercial.itens.length > 0;

        const btn = document.getElementById('btn-export-comercial');
        if (p && c && cons && temItens) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    function validarTecnico() {
        const temItens = dadosProjeto.tecnico.itens.length > 0;
        const btn = document.getElementById('btn-preview-tec');
        if (temItens) {
            btn.disabled = false;
        } else {
            btn.disabled = true;
        }
    }

    // --- COMERCIAL: Atualização ---
    function atualizarValoresComercial() {
        const select = document.getElementById('plano');
        const valorUnit = parseFloat(select.value) || 0;
        const qtd = parseInt(document.getElementById('qtdPlano').value) || 0;
        const temParceira = document.getElementById('parceiraCheck').value === 'sim';
        const qtdParc = parseInt(document.getElementById('qtdParceira').value) || 0;
        const valParc = parseFloat(document.getElementById('valorParceira').value) || 0;
        const totalParceira = temParceira ? (qtdParc * valParc) : 0;
        const totalItem = (valorUnit * qtd) + totalParceira;

        document.getElementById('valorUnitPlano').value = formatarMoeda(valorUnit);
        document.getElementById('totalItemPlano').value = formatarMoeda(totalItem);
    }

    function adicionarPlanoComercial() {
        const select = document.getElementById('plano');
        const valorUnit = parseFloat(select.value) || 0;
        if (valorUnit === 0) return alert("Selecione um plano válido.");

        let nomePlano = select.options[select.selectedIndex].text.split(' - ')[0];
        const qtd = parseInt(document.getElementById('qtdPlano').value) || 1;
        const servico = document.getElementById('servico').value;
        const dataE = document.getElementById('dataEntrega').value;
        const temParceira = document.getElementById('parceiraCheck').value === 'sim';
        const qtdParc = parseInt(document.getElementById('qtdParceira').value) || 0;
        const valParc = parseFloat(document.getElementById('valorParceira').value) || 0;
        const nomeFinal = temParceira ? `${nomePlano} - Parceira` : nomePlano;
        const totalItem = (valorUnit * qtd) + (qtdParc * valParc);

        const itemObj = {
            id: Date.now(),
            nome: nomeFinal,
            nomeOriginal: nomePlano, 
            qtd: qtd,
            valorUnit: valorUnit,
            servico: servico,
            dataEntrega: dataE,
            temParceira: temParceira,
            qtdParc: qtdParc,
            valParc: valParc,
            total: totalItem
        };

        if (editIndexCom !== null) {
            dadosProjeto.comercial.itens[editIndexCom] = itemObj;
            editIndexCom = null;
            const btn = document.getElementById('btn-add-comercial');
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> Adicionar Plano';
            btn.classList.remove('editing');
        } else {
            dadosProjeto.comercial.itens.push(itemObj);
        }

        select.value = "0";
        document.getElementById('qtdPlano').value = "1";
        document.getElementById('parceiraCheck').value = "nao";
        document.getElementById('qtdParceira').value = "0";
        document.getElementById('valorParceira').value = "0";
        toggleParceira();
        atualizarValoresComercial(); 
        renderizarResumo();
        validarComercial(); 
    }

    function exportarArquivoProjeto() {
        if(dadosProjeto.comercial.itens.length === 0) return alert("Adicione itens antes de salvar.");
        dadosProjeto.comercial.cliente = document.getElementById('projeto').value || "Cliente";
        dadosProjeto.comercial.cnpj = document.getElementById('cnpj').value;
        dadosProjeto.comercial.consultor = document.getElementById('consultor').value;
        dadosProjeto.id = Date.now();
        dadosProjeto.dataCriacao = new Date().toLocaleDateString('pt-BR'); 

        const dataStr = JSON.stringify(dadosProjeto);
        const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
        const linkElement = document.createElement('a');
        linkElement.setAttribute('href', dataUri);
        linkElement.setAttribute('download', `Viabilidade financeira_Projeto_${dadosProjeto.comercial.cliente}.json`);
        linkElement.click();
    }

    // --- TÉCNICO ---
    function carregarArquivo(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                dadosProjeto = JSON.parse(e.target.result);
                document.getElementById('tec_display_cliente').innerText = dadosProjeto.comercial.cliente;
                document.getElementById('tec_display_consultor').innerText = dadosProjeto.comercial.consultor || "---";
                document.getElementById('tec_display_data').innerText = dadosProjeto.dataCriacao || "---";
                document.getElementById('tec_display_itens_qtd').innerText = dadosProjeto.comercial.itens.length;
                document.getElementById('area-upload').style.display = 'none';
                document.getElementById('info-projeto-carregado').style.display = 'block';
                document.getElementById('area-tecnica-form').style.display = 'block';
                renderizarResumo();
                validarTecnico(); 
            } catch (err) {
                alert("Erro ao ler arquivo.");
            }
        };
        reader.readAsText(file);
    }

    function calcTotalItemTec() {
        const qtd = parseInt(document.getElementById('tec_qtd').value) || 0;
        const val = parseFloat(document.getElementById('tec_valor').value) || 0;
        document.getElementById('tec_total_preview').value = formatarMoeda(qtd * val);
    }

    function adicionarItemTecnico() {
        const nome = document.getElementById('tec_equipamento').value;
        if(!nome) return alert("Digite o nome do equipamento.");
        const qtd = parseInt(document.getElementById('tec_qtd').value) || 1;
        const valorUnit = parseFloat(document.getElementById('tec_valor').value) || 0;
        const tipo = document.getElementById('tec_tipo').value;
        const totalItem = qtd * valorUnit;

        const itemObj = {
            id: Date.now(),
            nome: nome,
            qtd: qtd,
            valorUnit: valorUnit,
            tipo: tipo,
            total: totalItem
        };

        if (editIndexTec !== null) {
            dadosProjeto.tecnico.itens[editIndexTec] = itemObj;
            editIndexTec = null;
            const btn = document.getElementById('btn-add-tecnico');
            btn.innerHTML = '<i class="fa-solid fa-plus"></i> Adicionar Item';
            btn.classList.remove('editing');
        } else {
            dadosProjeto.tecnico.itens.push(itemObj);
        }

        document.getElementById('tec_equipamento').value = "";
        document.getElementById('tec_qtd').value = "1";
        document.getElementById('tec_valor').value = "0";
        document.getElementById('tec_total_preview').value = "R$ 0,00";
        renderizarResumo();
        validarTecnico(); 
    }

    function editarItem(tipo, index) {
        if (tipo === 'com') {
            const item = dadosProjeto.comercial.itens[index];
            const select = document.getElementById('plano');
            for (let i = 0; i < select.options.length; i++) {
                if (select.options[i].text.includes(item.nomeOriginal)) {
                    select.selectedIndex = i;
                    break;
                }
            }
            document.getElementById('qtdPlano').value = item.qtd;
            document.getElementById('servico').value = item.servico;
            document.getElementById('dataEntrega').value = item.dataEntrega;
            document.getElementById('parceiraCheck').value = item.temParceira ? "sim" : "nao";
            document.getElementById('qtdParceira').value = item.qtdParc;
            document.getElementById('valorParceira').value = item.valParc;
            toggleParceira();
            atualizarValoresComercial();

            editIndexCom = index;
            const btn = document.getElementById('btn-add-comercial');
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Salvar Alteração';
            btn.classList.add('editing');
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth' });

        } else if (tipo === 'tec') {
            const item = dadosProjeto.tecnico.itens[index];
            document.getElementById('tec_equipamento').value = item.nome;
            document.getElementById('tec_qtd').value = item.qtd;
            document.getElementById('tec_valor').value = item.valorUnit;
            document.getElementById('tec_tipo').value = item.tipo;
            calcTotalItemTec();

            editIndexTec = index;
            const btn = document.getElementById('btn-add-tecnico');
            btn.innerHTML = '<i class="fa-solid fa-rotate"></i> Salvar Alteração';
            btn.classList.add('editing');
            document.getElementById('area-tecnica-form').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function removerItem(tipo, index) {
        if(confirm("Remover este item?")) {
            if(tipo === 'com') dadosProjeto.comercial.itens.splice(index, 1);
            if(tipo === 'tec') dadosProjeto.tecnico.itens.splice(index, 1);
            renderizarResumo();
            validarComercial(); 
            validarTecnico(); 
        }
    }

    function renderizarResumo() {
        const listaCom = document.getElementById('lista-resumo-com');
        const listaTec = document.getElementById('lista-resumo-tec');
        
        let totalComercial = 0;
        let totalTecnico = 0;
        
        const isTecnicoActive = document.getElementById('tela-tecnica').classList.contains('active');

        listaCom.innerHTML = "";
        if (dadosProjeto.comercial.itens.length > 0) {
            dadosProjeto.comercial.itens.forEach((item, index) => {
                totalComercial += item.total;
                
                // ESCONDE BOTÕES SE ESTIVER NA TELA TÉCNICA
                let btnsComercial = '';
                if (!isTecnicoActive) {
                    btnsComercial = `
                        <button class="btn-icon edit" onclick="editarItem('com', ${index})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn-icon del" onclick="removerItem('com', ${index})"><i class="fa-solid fa-trash"></i></button>
                    `;
                }

                listaCom.innerHTML += `
                    <li class="item-resumo">
                        <div class="item-info"><b>${item.nome}</b><span>${item.qtd}x ${formatarMoeda(item.valorUnit)}</span></div>
                        <div class="acoes-item">
                            <span style="font-weight:bold; margin-right:5px;">${formatarMoeda(item.total)}</span>
                            ${btnsComercial}
                        </div>
                    </li>`;
            });
        } else {
            listaCom.innerHTML = '<li style="color: #999; font-size: 12px; text-align: center;">Nenhum plano.</li>';
        }

        listaTec.innerHTML = "";
        if (dadosProjeto.tecnico.itens.length > 0) {
            dadosProjeto.tecnico.itens.forEach((item, index) => {
                totalTecnico += item.total;
                listaTec.innerHTML += `
                    <li class="item-resumo">
                        <div class="item-info"><b>${item.nome}</b><span>${item.tipo} | ${item.qtd}x ${formatarMoeda(item.valorUnit)}</span></div>
                        <div class="acoes-item">
                            <span style="font-weight:bold; margin-right:5px;">${formatarMoeda(item.total)}</span>
                            <button class="btn-icon edit" onclick="editarItem('tec', ${index})"><i class="fa-solid fa-pen"></i></button>
                            <button class="btn-icon del" onclick="removerItem('tec', ${index})"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </li>`;
            });
        } else {
            listaTec.innerHTML = '<li style="color: #999; font-size: 12px; text-align: center;">Nenhum equipamento.</li>';
        }

        // ATUALIZA TOTAIS SEPARADOS
        document.getElementById('valTotalComercial').innerText = formatarMoeda(totalComercial);
        document.getElementById('valTotalTecnico').innerText = formatarMoeda(totalTecnico);
    }

    // --- DOC GENERATION ---
    function montarHTMLDocumento(completo) {
        const com = dadosProjeto.comercial;
        const tec = dadosProjeto.tecnico;
        
        if(!completo) {
            com.cliente = document.getElementById('projeto').value || "Cliente";
            com.cnpj = document.getElementById('cnpj').value || "---";
            com.consultor = document.getElementById('consultor').value || "---";
        }

        const dataRef = com.itens.length > 0 ? formatarDataBR(com.itens[0].dataEntrega) : "---";
        const servicoRef = com.itens.length > 0 ? com.itens[0].servico : "---";
        
        const totalComercial = com.itens.reduce((a,i)=>a+i.total,0);
        const totalTecnico = tec.itens.reduce((a,i)=>a+i.total,0);
        const faturamento = totalComercial - totalTecnico; 
        
        const contingencia = totalTecnico * 0.02;
        const totalComContingencia = totalTecnico + contingencia;

        const hoje = new Date().toLocaleDateString('pt-BR');

        // Styles for Word
        const primaryColor = "#2c3e50"; 
        const lightGray = "#f8f9fa";
        const borderColor = "#e9ecef";
        const sectionTitleStyle = `font-size:14pt; color:${primaryColor}; font-weight:bold; margin-top:30px; margin-bottom:15px; padding-bottom:5px; border-bottom:2px solid ${borderColor}; text-transform:uppercase; letter-spacing:0.5px;`;
        
        const tableStyle = `width:100%; border-collapse:collapse; margin-bottom:20px; font-size:10.5pt;`;
        const thStyle = `background:${lightGray}; color:${primaryColor}; padding:12px 8px; text-align:left; font-weight:bold; border-bottom:2px solid ${borderColor};`;
        const tdStyle = `padding:10px 8px; border-bottom:1px solid ${borderColor}; color:#555; vertical-align:middle;`;
        const boldTdStyle = `${tdStyle} font-weight:bold; color:${primaryColor};`;
        const labelStyle = `color:${primaryColor}; font-weight:bold; font-size:10pt; text-transform:uppercase; display:block; margin-bottom:3px;`;
        const valueStyle = `color:#666; font-size:11pt;`;

        const linhasCom = com.itens.map(i => `
            <tr>
                <td style="${tdStyle}">${i.nome}</td>
                <td style="${tdStyle} text-align:center;">${i.qtd}</td>
                <td style="${tdStyle} text-align:right;">${formatarMoeda(i.valorUnit)}</td>
                <td style="${boldTdStyle} text-align:right;">${formatarMoeda(i.total)}</td>
            </tr>`).join('');

        const linhasTec = tec.itens.map(i => `
            <tr>
                <td style="${tdStyle}">${i.nome} <br><span style="font-size:9pt; color:#999;">(Tipo: ${i.tipo})</span></td>
                <td style="${tdStyle} text-align:center;">${i.qtd}</td>
                <td style="${tdStyle} text-align:right;">${formatarMoeda(i.valorUnit)}</td>
                <td style="${boldTdStyle} text-align:right;">${formatarMoeda(i.total)}</td>
            </tr>`).join('');

        const blocoTecnico = completo ? `
            <div style="${sectionTitleStyle}">3. Escopo Técnico</div>
            <table style="${tableStyle}">
                <thead>
                    <tr>
                        <th style="${thStyle}">Item / Descrição</th>
                        <th style="${thStyle} width:10%; text-align:center;">Qtd.</th>
                        <th style="${thStyle} width:20%; text-align:right;">Unitário</th>
                        <th style="${thStyle} width:20%; text-align:right;">Total</th>
                    </tr>
                </thead>
                <tbody>${linhasTec.length ? linhasTec : `<tr><td colspan="4" style="${tdStyle} text-align:center; color:#999;">Nenhum item técnico.</td></tr>`}</tbody>
            </table>
        ` : '';

        const blocoResumo = completo ? `
            
            <div style="border-top: 3px solid #000; margin-top: 40px; margin-bottom: 30px;"></div>

            <div style="${sectionTitleStyle}; border-bottom: none; margin-top: 0;">4. Resumo Financeiro e Contingência</div>
            
            <table style="width:100%; background:#f1f3f5; border:1px solid #e9ecef; border-radius:8px;">
                <tr>
                    <td style="padding:20px; border-bottom:1px solid #dee2e6;">
                        <span style="font-weight:bold; color:${primaryColor}; display:block;">Total Comercial (Arrecadação):</span>
                        <span style="font-size:12pt; color:#555;">${formatarMoeda(totalComercial)}</span>
                    </td>
                    <td style="padding:20px; border-bottom:1px solid #dee2e6; text-align:right;">
                        <span style="font-weight:bold; color:${primaryColor}; display:block;">Total Técnico (Custo Estimado):</span>
                        <span style="font-size:12pt; color:#555;">${formatarMoeda(totalTecnico)}</span>
                    </td>
                </tr>
                 <tr>
                    <td colspan="2" style="padding:20px; text-align:right; border-bottom:1px solid #dee2e6;">
                        <span style="font-weight:bold; font-size:11pt; color:#333; display:block;">Faturamento Previsto:</span>
                        <span style="font-size:16pt; font-weight:bold; color:${faturamento >= 0 ? '#28a745' : '#dc3545'};">${formatarMoeda(faturamento)}</span>
                    </td>
                </tr>
                <tr>
                    <td colspan="2" style="padding:20px;">
                        <span style="font-weight:bold; color:${primaryColor}; display:block; margin-bottom:5px;">Margem de Contingência (2% sobre Custo Técnico):</span>
                        <div style="font-size:10pt; color:#666;">
                            Adicional estimado de <b>${formatarMoeda(contingencia)}</b> para imprevistos.<br>
                            Custo Técnico Final (Teto com margem): <b style="color:#333;">${formatarMoeda(totalComContingencia)}</b>.
                        </div>
                    </td>
                </tr>
            </table>
        ` : '';

        return `
            <div style="font-family:'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size:11pt; line-height:1.6; color:#333; padding:30px; background:#fff;">
                
                <table style="width:100%; margin-bottom:40px;">
                    <tr>
                        <td style="text-align:center;">
                            <h1 style="margin:0; font-size:24pt; color:${primaryColor}; text-transform:uppercase; font-weight:300; letter-spacing:2px;">Viabilidade Financeira</h1>
                            <p style="margin-top:10px; font-size:10pt; color:#777; border-top:1px solid ${borderColor}; display:inline-block; padding-top:10px;">Emitido em: ${hoje}</p>
                        </td>
                    </tr>
                </table>

                <div style="${sectionTitleStyle}">1. Dados do Projeto</div>
                
                <table style="width:100%; background:${lightGray}; border-radius:8px; padding:20px; border-spacing: 20px;">
                    <tr>
                        <td width="50%" valign="top"><span style="${labelStyle}">Cliente:</span><span style="${valueStyle}">${com.cliente}</span></td>
                        <td width="50%" valign="top"><span style="${labelStyle}">CNPJ:</span><span style="${valueStyle}">${com.cnpj}</span></td>
                    </tr>
                    <tr>
                        <td valign="top"><span style="${labelStyle}">Consultor:</span><span style="${valueStyle}">${com.consultor}</span></td>
                        <td valign="top"><span style="${labelStyle}">Previsão Entrega:</span><span style="${valueStyle}">${dataRef}</span></td>
                    </tr>
                    <tr>
                        <td colspan="2" valign="top" style="border-top:1px solid ${borderColor}; padding-top:15px;">
                            <span style="${labelStyle}">Tipo de Serviço:</span><span style="${valueStyle}">${servicoRef}</span>
                        </td>
                    </tr>
                </table>

                <div style="${sectionTitleStyle}">2. Proposta Comercial</div>
                <table style="${tableStyle}">
                    <thead>
                        <tr>
                            <th style="${thStyle}">Item / Descrição</th>
                            <th style="${thStyle} width:10%; text-align:center;">Qtd.</th>
                            <th style="${thStyle} width:20%; text-align:right;">Unitário</th>
                            <th style="${thStyle} width:20%; text-align:right;">Total</th>
                        </tr>
                    </thead>
                    <tbody>${linhasCom.length ? linhasCom : `<tr><td colspan="4" style="${tdStyle} text-align:center; color:#999;">Nenhum item comercial.</td></tr>`}</tbody>
                </table>

                ${blocoTecnico}
                ${blocoResumo}
            </div>`;
    }

    function abrirPreview(completo) {
        modoCompletoGlobal = completo; 
        const html = montarHTMLDocumento(completo);
        document.getElementById('papelSimulacao').innerHTML = html;
        document.getElementById('modalPreview').style.display = 'flex';
    }

    function fecharPreview() {
        document.getElementById('modalPreview').style.display = 'none';
    }

    function baixarDoModal() {
        const html = montarHTMLDocumento(modoCompletoGlobal);
        const content = `<!DOCTYPE html><html><head><meta charset="utf-8"></head><body>${html}</body></html>`;
        
        const converted = htmlDocx.asBlob(content, { orientation: 'portrait', margins: { top: 720 } });
        
        const sufixo = modoCompletoGlobal ? 'Completo' : 'Comercial';
        saveAs(converted, `Viabilidade_${dadosProjeto.comercial.cliente}_${sufixo}.docx`);
        
        fecharPreview(); 
    }

    function mascaraCNPJ(i) {
        let v = i.value.replace(/\D/g, "").substring(0, 14);
        v = v.replace(/^(\d{2})(\d)/, "$1.$2").replace(/^(\d{2})\.(\d{3})(\d)/, "$1.$2.$3").replace(/\.(\d{3})(\d)/, ".$1/$2").replace(/(\d{4})(\d)/, "$1-$2");
        i.value = v;
    }
    function toggleParceira() {
        document.getElementById('secao-parceira').style.display = document.getElementById('parceiraCheck').value === 'sim' ? 'block' : 'none';
        atualizarValoresComercial();
    }
    function formatarMoeda(v) { return v.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }
    function formatarDataBR(d) { return d ? d.split('-').reverse().join('/') : "---"; }
</script>
</body>
</html>

